{% extends 'base.html' %}

{% block title %}{{ task.task_type|default:"Task" }} - Tasks{% endblock %}

{% block body %}
<!-- Breadcrumb -->
<nav class="flex mb-4" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2 text-sm">
        <li>
            <a href="{% url 'tasks_list' %}" class="text-gray-500 hover:text-gray-700">Tasks</a>
        </li>
        <li class="flex items-center">
            <svg class="w-4 h-4 text-gray-400 mx-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-gray-900">{{ task.name }}</span>
        </li>
    </ol>
</nav>

<!-- Header -->
<div class="flex items-start justify-between mb-6">
    <div>
        <h1 class="text-2xl font-light text-gray-900">
            <code class="text-lg bg-gray-100 px-2 py-1 rounded">{{ task.task_type|default:"Unknown task" }}</code>
        </h1>
        <p class="text-gray-500 mt-1">
            {{ task.name }}
            <span class="text-gray-400 text-sm">({{ task.id }})</span>
        </p>
    </div>
    {% if can_cancel and task.status in 'queued,in_progress' %}
    <form method="post" action="{% url 'task_cancel' task.id %}" onsubmit="return confirm('Are you sure you want to cancel this task?');">
        {% csrf_token %}
        <button type="submit" class="inline-flex items-center px-4 py-2 border border-red-600 text-sm font-medium rounded-lg text-red-600 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel Task
        </button>
    </form>
    {% endif %}
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Task Info & Logs -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Task Information Card -->
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h2 class="text-lg font-medium text-gray-900">Task Information</h2>
            </div>
            <div class="p-6">
                <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Status</dt>
                        <dd class="mt-1" id="task-status" data-status="{{ task.status }}">
                            {% include "partials/_status_badge.html" with status=task.status %}
                        </dd>
                    </div>

                    <div id="task-progress-container" class="{% if not task.total_items %}hidden{% endif %}">
                        <dt class="text-sm font-medium text-gray-500">Progress</dt>
                        <dd class="mt-1">
                            <div class="flex items-center">
                                <div class="flex-1 bg-gray-200 rounded-full h-2.5 mr-3">
                                    <div id="progress-bar" class="bg-green-600 h-2.5 rounded-full transition-all duration-300" style="width: {{ task.progress_percent|default:0 }}%"></div>
                                </div>
                                <span id="progress-text" class="text-sm text-gray-600 whitespace-nowrap">
                                    {{ task.completed_items|default:0 }}/{{ task.total_items|default:0 }}
                                </span>
                            </div>
                        </dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Created At</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ task.created_at|date:"Y-m-d H:i:s" }}</dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Started At</dt>
                        <dd class="mt-1 text-sm text-gray-900" id="task-started-at">
                            {% if task.started_at %}
                                {{ task.started_at|date:"Y-m-d H:i:s" }}
                            {% else %}
                                <span class="text-gray-400">Not started</span>
                            {% endif %}
                        </dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Completed At</dt>
                        <dd class="mt-1 text-sm text-gray-900" id="task-completed-at">
                            {% if task.completed_at %}
                                {{ task.completed_at|date:"Y-m-d H:i:s" }}
                            {% else %}
                                <span class="text-gray-400">Not completed</span>
                            {% endif %}
                        </dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Duration</dt>
                        <dd class="mt-1 text-sm text-gray-900" id="task-duration">
                            {% if task.duration %}{{ task.duration }}s{% else %}<span class="text-gray-400">-</span>{% endif %}
                        </dd>
                    </div>
                </dl>
            </div>
        </div>

        <!-- Logs Card -->
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
                <h2 class="text-lg font-medium text-gray-900">Logs</h2>
                <span id="logs-loading" class="hidden">
                    <svg class="animate-spin h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </div>
            <div class="p-6" id="task-logs-container">
                {% if task.logs %}
                <pre class="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto max-h-96 overflow-y-auto" id="task-logs" style="white-space: pre-wrap;">{{ task.logs }}</pre>
                {% else %}
                <p class="text-gray-400 text-center py-4" id="task-no-logs">No logs available for this task.</p>
                {% endif %}
            </div>
        </div>

        <a href="{% url 'tasks_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Tasks
        </a>
    </div>

    <!-- Audit Trail Sidebar -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h2 class="text-lg font-medium text-gray-900">Audit Trail</h2>
            </div>
            <ul class="divide-y divide-gray-200" id="audit-trail-container">
                <li class="px-6 py-4 text-center text-gray-400">Loading...</li>
            </ul>
        </div>
    </div>
</div>

<script>
(function() {
    const taskId = '{{ task.id }}';
    const statusApiUrl = '{% url "task_status_json" task.id %}';
    const auditApiUrl = '{% url "task_audit_json" task.id %}';
    let pollInterval = null;

    // Status badge templates (Tailwind)
    const statusBadges = {
        'queued': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Queued</span>',
        'in_progress': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">In Progress</span>',
        'success': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Success</span>',
        'completed_with_errors': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Completed with Errors</span>',
        'failed': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Failed</span>',
        'cancelled': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-white">Cancelled</span>'
    };

    // Event badge classes (Tailwind)
    const eventBadgeClasses = {
        'created': 'bg-gray-100 text-gray-800',
        'started': 'bg-blue-100 text-blue-800',
        'completed': 'bg-green-100 text-green-800',
        'completed_with_errors': 'bg-yellow-100 text-yellow-800',
        'failed': 'bg-red-100 text-red-800',
        'cancelled': 'bg-gray-700 text-white'
    };

    function isSettled(status) {
        return ['success', 'completed_with_errors', 'failed', 'cancelled'].includes(status);
    }

    function formatTimestamp(isoString) {
        if (!isoString) return null;
        const date = new Date(isoString);
        return date.toLocaleString();
    }

    function renderAuditTrail(entries) {
        const container = document.getElementById('audit-trail-container');
        if (!entries || entries.length === 0) {
            container.innerHTML = '<li class="px-6 py-4 text-center text-gray-400">No events recorded.</li>';
            return;
        }

        container.innerHTML = entries.map(entry => {
            const badgeClass = eventBadgeClasses[entry.event] || 'bg-gray-100 text-gray-800';
            return `
                <li class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeClass}">${entry.event_display}</span>
                        <span class="text-xs text-gray-500">${formatTimestamp(entry.created_at)}</span>
                    </div>
                </li>
            `;
        }).join('');
    }

    function updateTaskData(data) {
        const task = data.task;

        // Update status badge
        const statusElement = document.getElementById('task-status');
        if (statusElement) {
            statusElement.setAttribute('data-status', task.status);
            statusElement.innerHTML = statusBadges[task.status] || statusBadges['queued'];
        }

        // Update timestamps
        const startedAtElement = document.getElementById('task-started-at');
        if (startedAtElement) {
            startedAtElement.innerHTML = task.started_at ? formatTimestamp(task.started_at) : '<span class="text-gray-400">Not started</span>';
        }

        const completedAtElement = document.getElementById('task-completed-at');
        if (completedAtElement) {
            completedAtElement.innerHTML = task.completed_at ? formatTimestamp(task.completed_at) : '<span class="text-gray-400">Not completed</span>';
        }

        // Update duration
        const durationElement = document.getElementById('task-duration');
        if (durationElement) {
            durationElement.innerHTML = task.duration ? task.duration + 's' : '<span class="text-gray-400">-</span>';
        }

        // Update logs
        const logsContainer = document.getElementById('task-logs-container');
        if (logsContainer) {
            if (task.logs) {
                logsContainer.innerHTML = '<pre class="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto max-h-96 overflow-y-auto" id="task-logs" style="white-space: pre-wrap;">' + task.logs + '</pre>';
            } else {
                logsContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No logs available.</p>';
            }
        }

        // Update progress bar
        const progressContainer = document.getElementById('task-progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        if (task.total_items && progressContainer && progressBar && progressText) {
            progressContainer.classList.remove('hidden');
            progressBar.style.width = (task.progress_percent || 0) + '%';
            progressText.textContent = (task.completed_items || 0) + '/' + task.total_items;
        } else if (progressContainer) {
            progressContainer.classList.add('hidden');
        }

        if (isSettled(task.status)) {
            stopPolling();
        }
    }

    function fetchTaskStatus() {
        const loadingIndicator = document.getElementById('logs-loading');
        if (loadingIndicator) loadingIndicator.classList.remove('hidden');

        Promise.all([
            fetch(statusApiUrl).then(r => r.json()),
            fetch(auditApiUrl).then(r => r.json())
        ])
        .then(([statusData, auditData]) => {
            if (statusData.success) updateTaskData(statusData);
            if (auditData.success) renderAuditTrail(auditData.audit_trail);
        })
        .catch(error => console.error('Error fetching task data:', error))
        .finally(() => {
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
        });
    }

    function startPolling() {
        const currentStatus = document.getElementById('task-status').getAttribute('data-status');
        if (!isSettled(currentStatus)) {
            fetchTaskStatus();
            pollInterval = setInterval(fetchTaskStatus, 5000);
        } else {
            // Load audit trail once for settled tasks
            fetch(auditApiUrl).then(r => r.json()).then(data => {
                if (data.success) renderAuditTrail(data.audit_trail);
            });
        }
    }

    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }

    startPolling();

    document.addEventListener('visibilitychange', function() {
        if (document.hidden) stopPolling();
        else startPolling();
    });
})();
</script>
{% endblock body %}
